# レシピ65: テスト実行とレポート集約（バックグラウンド実行）

サブエージェントをバックグラウンドで実行し、テスト結果を待ちながら他の作業を並行して進めます。テスト実行専用のカスタムサブエージェントを定義し、レポートをファイルに出力します。

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| `.claude/agents/test-runner.md` | テスト実行とレポート生成を行うカスタムサブエージェント定義 |
| `prompts/background-test.txt` | バックグラウンドでテストスイートを実行するプロンプト例 |
| `prompts/parallel-test-suites.txt` | 複数テストスイートを並列バックグラウンドで実行するプロンプト例 |

## 使い方

```bash
# テスト実行エージェントをプロジェクトに配置
cp -r .claude /path/to/your-project/

# バックグラウンドでテストを実行
> バックグラウンドでテストスイートを実行し、レポートを作成してください

# 実行中にCtrl+Bでバックグラウンドに切り替えることも可能
# テスト完了後に結果を確認
> 先ほどのテスト結果を確認して。失敗テストがあれば修正して
```

## バックグラウンド実行の2つの方法

| 方法 | 説明 |
|------|------|
| 事前指定 | 「バックグラウンドで実行して」と明示的に指示する |
| 実行中切替 | サブエージェント実行中に`Ctrl+B`を押してバックグラウンドに切り替える |

## バックグラウンドサブエージェントの制約

- 起動前に必要なツール許可を事前に取得する
- 実行中は事前許可済みの操作のみ実行可能
- MCPサーバー経由のツールは利用できない
- AskUserQuestionによるユーザーへの質問は失敗する
- 権限不足で失敗した場合、フォアグラウンドで再開可能

## 設計のポイント

- **結果をファイルに書き出す**: `test-report.md`等に出力することで、完了後にファイルを読むだけで結果を確認できる
- **MCPサーバーが不要な処理に限定する**: 単体テスト、リンター、静的解析がバックグラウンドに最適
- **`CLAUDE_CODE_DISABLE_BACKGROUND_TASKS=1`**: チームのポリシーでバックグラウンド実行を禁止する場合に設定する
- **SubagentStopフックとの連携**: テスト完了時にデスクトップ通知を送るワークフローを構築できる

## 関連レシピ

- レシピ57「Taskツールの仕組みと独立コンテキスト」
- レシピ82「SubagentStart/SubagentStopフックで制御する」
- レシピ87「タスク完了時にデスクトップ/サウンド通知を自動送信する」
