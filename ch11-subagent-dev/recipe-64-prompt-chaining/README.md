# レシピ64: Prompt Chainingと中間ゲート設計

サブエージェントはネスト（入れ子）ができないため、メインの会話がオーケストレーターとなり、サブエージェントを順次呼び出すチェーン方式でワークフローを構築します。各ステップの間に「中間ゲート」を設けることで、方向修正やフィードバックを挟めます。

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| `prompts/chain-workflow.txt` | 4ステップのチェーンワークフロー（分析→計画→実装→検証）のプロンプト例 |
| `prompts/conditional-gate.txt` | テスト結果に応じた条件分岐ゲートのプロンプト例 |
| `prompts/resume-pattern.txt` | セッション中断・再開パターンのプロンプト例 |

## 使い方

```bash
# チェーンワークフローの実行
> 以下のワークフローをステップバイステップで実行してください。
> 各ステップの結果を確認してから次に進んでください。
>
> Step 1（分析）:
>   Exploreサブエージェントで src/api/ のエラーハンドリングの現状を分析する
>
> Step 2（計画）:
>   分析結果を踏まえて、統一エラーハンドリングの設計案を作成する
>   → ここで設計案を私に確認してください
>
> Step 3（実装）:
>   承認された設計案に基づいて実装する
>
> Step 4（検証）:
>   全テストを実行し、既存機能への影響がないことを確認する
```

## チェーン方式の基本構造

```
メインの会話（オーケストレーター）
  |
  +-- Step 1: [Explore] 問題の分析
  |     +-- 分析結果をメインに返す
  |
  +-- 中間ゲート: 分析結果を確認し、計画を承認
  |
  +-- Step 2: [Plan] 解決策の立案
  |     +-- 計画をメインに返す
  |
  +-- 中間ゲート: 計画を確認し、実行を承認
  |
  +-- Step 3: [general-purpose] 実装の実行
  |     +-- 実行結果をメインに返す
  |
  +-- Step 4: [general-purpose] テストと検証
        +-- 最終結果をメインに返す
```

## 中間ゲートの種類

| ゲート種別 | 説明 | 適する場面 |
|-----------|------|-----------|
| 自動ゲート | 前ステップの結果を自動的に次ステップに渡す | 定型的なワークフロー |
| 確認ゲート | ユーザーに結果を提示し承認を求める | 重要な判断ポイント |
| 条件分岐ゲート | 結果に応じて次のステップを選択する | エラー処理や分岐ロジック |

## 設計のポイント

- **「ここで確認してください」の一文が中間ゲート**: Claude Codeはこの指示に従い、結果を提示して承認を待つ
- **条件分岐を明示的に記述する**: テスト失敗件数に応じた対応を事前に指定しておく
- **各ステップの結果をファイルに保存する**: `.claude/workflow/step1-result.md`のようなファイルに書き出すことでコンテキスト消費を抑える
- **チェーン設計図をSkillsとして定義する**: ワークフロー全体を`/workflow-name`で再利用可能にする

## 関連レシピ

- レシピ57「Taskツールの仕組みと独立コンテキスト」
- レシピ63「マルチファイルリファクタリングの自動化」
- レシピ95「CI/CDパイプラインでの実行」
