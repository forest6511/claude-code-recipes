# レシピ63: マルチファイルリファクタリングの自動化

「調査フェーズ」（Exploreサブエージェント）と「実行フェーズ」（general-purposeサブエージェント）を分離し、リファクタリングを安全に自動化します。読み取り専用のExploreで影響範囲を把握してから、書き込み権限のあるgeneral-purposeで変更を行う2段階方式です。

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| `.claude/agents/refactorer.md` | マルチファイルリファクタリング専用のカスタムサブエージェント定義 |
| `prompts/phase1-investigation.txt` | 調査フェーズ（Explore）のプロンプト例 |
| `prompts/phase2-execution.txt` | 実行フェーズ（general-purpose）のプロンプト例 |
| `prompts/parallel-refactoring.txt` | 独立した変更を並列で実行するプロンプト例 |

## 使い方

```bash
# リファクタリングエージェントをプロジェクトに配置
cp -r .claude /path/to/your-project/

# 2フェーズ方式でリファクタリングを実行
> Exploreサブエージェントを使って、UserServiceクラスをインターフェース分離に
> 変更するリファクタリングの影響範囲を調査してください
# （調査結果を確認してから）
> 調査結果を踏まえて、UserServiceのリファクタリングを実行してください
```

## 2フェーズ戦略

```
フェーズ1: 調査（Exploreサブエージェント）
  +-- 変更対象ファイルの特定、影響範囲の分析

フェーズ2: 実行（general-purposeサブエージェント）
  +-- ファイルの変更、テスト実行、結果の検証
```

## 設計のポイント

- **調査と実行の分離**: 影響範囲を事前に把握することで「変更したら予期しない箇所が壊れた」を防ぐ
- **permissionMode: acceptEdits**: 命名規則の統一やimportパスの変更など機械的な変更は自動許可が効率的
- **並列実行の条件**: 変更対象のファイルが重複しない場合にのみ有効。同じファイルを複数のサブエージェントが同時に編集するとコンフリクトが発生する
- **テストによるガード**: 各ステップ完了後にテストを実行し、失敗時は停止して原因を報告させる

## 関連レシピ

- レシピ60「tools/disallowedToolsで権限を制御する」
- レシピ61「永続メモリパターン」
- レシピ64「Prompt Chainingと中間ゲート設計」
