# レシピ61: 永続メモリパターン（MEMORY.md）

エージェントにクロスセッションの学習能力を持たせ、セッションをまたいで知識を蓄積・活用する方法を解説します。

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| `.claude/agents/memory-reviewer.md` | プロジェクト知識を蓄積しながらコードレビューを行うエージェント（`memory: project`指定） |
| `.claude/agent-memory/memory-reviewer/MEMORY.md` | エージェントが読み書きする知識ベースの初期テンプレート |

## 使い方

```bash
# プロジェクトに配置
cp -r .claude /path/to/your-project/.claude

# エージェントを呼び出し（初回）
> @memory-reviewer src/auth/ディレクトリをレビューして

# 2回目以降は過去の知識が反映される
> @memory-reviewer src/api/ディレクトリをレビューして
# → 前回のレビューで蓄積したパターンに基づいて指摘が行われる
```

## メモリスコープの種類

エージェント定義のフロントマターで`memory`フィールドを指定します。

| スコープ | 保存先 | 共有範囲 | 用途 |
|---------|--------|---------|------|
| `user` | `~/.claude/agent-memory/<name>/MEMORY.md` | 全プロジェクトで共有 | 個人の汎用的な知見・スタイル |
| `project` | `.claude/agent-memory/<name>/MEMORY.md` | 同一プロジェクト内 | プロジェクト固有のルール・パターン |
| `local` | `.claude/local/agent-memory/<name>/MEMORY.md` | ローカルのみ（Git管理外） | 個人設定、機密を含む知識 |

### スコープの使い分け

```yaml
# 全プロジェクトで共有したい知見
---
memory: user
---
# 例: コーディングスタイルの好み、汎用的なベストプラクティス

# プロジェクト固有の知識（チームで共有）
---
memory: project
---
# 例: プロジェクトの設計規約、アーキテクチャ判断

# ローカル限定の知識（Git管理外）
---
memory: local
---
# 例: 個人的なメモ、ローカル環境固有の設定
```

## MEMORY.mdの書き方

### 効果的なMEMORY.mdの構造

```markdown
# [エージェント名] - 知識ベース

## プロジェクト概要
[プロジェクトの基本情報]

## 学習したルール
[レビューや作業を通じて蓄積されたルール]

## 頻出パターン
[繰り返し見つかるパターンと対処法]

## 設計判断の記録
[チームで合意された設計上の決定]

## 統計情報
[作業の累計回数、傾向など]
```

### MEMORY.mdの運用ルール

1. **構造化**: セクションを明確に分け、情報を整理する
2. **簡潔さ**: 1項目は1〜2行で記述する（冗長な説明は避ける）
3. **日付記録**: 重要な判断には日付を付ける
4. **定期整理**: 古くなった情報は定期的にアーカイブする
5. **機密排除**: パスワード、APIキー等の機密情報は記録しない

## Git管理の考え方

| スコープ | Git管理 | 理由 |
|---------|---------|------|
| `project` | する | チームで知識を共有するため |
| `user` | しない | 個人の設定ディレクトリ内 |
| `local` | しない | `.claude/local/`はデフォルトで`.gitignore`対象 |

## 設計のポイント

- メモリが肥大化するとコンテキストを圧迫するため、定期的な整理が必要
- 初期テンプレートを用意しておくと、エージェントの学習が効率的に始まる
- `project`スコープのメモリはGit管理してチーム全体で知識を共有する

## 関連レシピ

- レシピ59「カスタムエージェントの定義」
- レシピ66「サブエージェント駆動のコードレビュー」
- レシピ08「/compactのカスタム圧縮指示とタイミング戦略」
