# レシピ57: Taskツールの仕組みと独立コンテキスト

サブエージェントの基本概念を理解するための概念説明レシピです。

## 概要

Claude Codeの`Task`ツールは、メインのClaudeセッションから独立したコンテキストを持つサブエージェントを起動する仕組みです。メインセッションのコンテキストウィンドウを消費せずに、専門的な作業を並列で実行できます。

## Taskツールの動作モデル

### フォアグラウンド実行

```
メインセッション
├── Task("コードをレビューして") ← フォアグラウンド
│   └── サブエージェント起動
│       ├── 独立コンテキスト（メインとは別）
│       ├── CLAUDE.mdは継承される
│       ├── 作業実行...
│       └── 結果をメインに返却 ← メインは待機
└── 結果を受け取って続行
```

- メインセッションはサブエージェントの完了を待つ
- 結果はメインセッションに返却される

### バックグラウンド実行

```
メインセッション
├── Task("テストを実行して") ← バックグラウンド (Ctrl+B)
│   └── サブエージェント起動（別プロセス）
├── メインは待たずに続行 ← 並列作業可能
└── 後で結果を確認
```

- メインセッションはサブエージェントの完了を待たない
- `Ctrl+B`でバックグラウンドに切り替え可能
- 完了通知で結果を確認

### 再開機能

サブエージェントが中断した場合、セッションを再開できます。

```bash
# 中断されたセッションを確認
claude session list

# セッションを再開
claude session resume <session-id>
```

## サブエージェントの制約

| 制約 | 説明 |
|------|------|
| コンテキスト独立 | メインセッションの会話履歴は引き継がない |
| `CLAUDE.md`継承 | プロジェクトの`CLAUDE.md`は読み込まれる |
| ツール制限 | `tools`/`disallowedTools`で使用可能ツールを制限可能 |
| 権限継承 | メインセッションの権限設定を継承する |
| ネスト可能 | サブエージェントが更にサブエージェントを起動可能（ただし深さに注意） |

## 設計のポイント

- サブエージェントはメインセッションのコンテキストを汚染しない
- 明確なタスク記述（プロンプト）が結果の品質を左右する
- 長時間タスクにはバックグラウンド実行を活用する
- 過度なネストは避ける（2段階までが推奨）

## 関連レシピ

- レシピ58「エージェント種別の使い分け」
- レシピ59「カスタムエージェントの定義」
- レシピ62「並列実行で大規模コードベースを高速調査する」
